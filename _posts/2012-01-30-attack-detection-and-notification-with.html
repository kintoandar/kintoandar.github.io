---
layout: post
title: Attack detection and notification with iptables, psad and notify-send
date: '2012-01-30T18:04:00.001Z'
author: Joel Bastos
tags: 
modified_time: '2012-12-20T23:31:39.498Z'
thumbnail: https://1.bp.blogspot.com/-cBUzvsvN724/TybH7Mm75fI/AAAAAAAAAfk/hESViFRU8pg/s72-c/burning-flame.jpg
blogger_id: tag:blogger.com,1999:blog-1780138848439428569.post-9127310887048231163
blogger_orig_url: http://blog.kintoandar.com/2012/01/attack-detection-and-notification-with.html
comments: true
---

<div class="separator" style="clear: both; text-align: center;"><a href="http://kintoandar.blogspot.com/2012/01/attack-detection-and-notification-with.html" imageanchor="1" style="margin-left: 1em; margin-right: 1em;" target="_blank"><img border="0" height="320" src="https://1.bp.blogspot.com/-cBUzvsvN724/TybH7Mm75fI/AAAAAAAAAfk/hESViFRU8pg/s320/burning-flame.jpg" width="252" /></a></div><div><span style="font-family: arial,helvetica,sans-serif;"></span></div><div><span style="font-family: arial,helvetica,sans-serif;">For some time now I've been searching for some way to integrate firewall log alerts into my desktop.</span><br /><br /></div><div></div><div class="separator" style="clear: both; text-align: left;"><a href="http://www.fs-security.com/" imageanchor="1" style="clear: left; float: left; margin-bottom: 1em; margin-right: 1em;" target="_blank"><img border="0" height="63" src="https://2.bp.blogspot.com/--bO2B7wUPaw/TybTGi28wKI/AAAAAAAAAf8/DOdOWdDmvgk/s320/firestarter.png" width="320" /></a><span style="font-family: arial,helvetica,sans-serif;">A few years  back (before I started to truly enjoy iptables) I was a firestarter  user, <a href="http://kintoandar.blogspot.com/2008/09/firestarter-firewall-switch.html" target="_blank">I even wrote a handy script for it</a> and really liked the  notifications it provided.</span></div><div class="separator" style="clear: both; text-align: left;"><br /></div><div></div><div><span style="font-family: arial,helvetica,sans-serif;"></span></div><div><span style="font-family: arial,helvetica,sans-serif;"></span></div><div class="separator" style="clear: both; text-align: center;"><a href="http://www.netfilter.org/projects/iptables/index.html" imageanchor="1" style="clear: right; float: right; margin-bottom: 1em; margin-left: 1em;" target="_blank"><img border="0" src="https://4.bp.blogspot.com/-QtMMrzrXhNY/TybItmW6LhI/AAAAAAAAAf0/6M4KwTVnr8Y/s1600/netfilter.png" /></a></div><div><span style="font-family: arial,helvetica,sans-serif;">Nowadays I  crave for iptables scripts and can't stand firestarter interface, this  became a problem. How could I have an elegant way of being notified of  potential threats without depending on email alerts or log watching?</span><br /><br /></div><div></div><div><span style="font-family: arial,helvetica,sans-serif;">Using <a href="http://kintoandar.blogspot.com/2010/12/conky-config-eee-netbook.html" target="_blank">conky seemed a cool alternative</a> and its scripting capabilities were  indeed a solution for my problem. But soon realized I always keep  windows maximized and didn't notice conky on the background, alerts  were ignore and the idea buried. Yesterday, as I watched a pop-up notification on my screen another idea just poped (pun intended).</span></div><div><span style="font-family: arial,helvetica,sans-serif;"><br clear="none" /></span></div><div><span style="font-family: arial,helvetica,sans-serif;">There should  be a way to easily parse iptables logs matching them with known attack  signatures, and guess what?... There is, it's called psad, and you  probably remember me <a href="http://kintoandar.blogspot.com/2010/02/book-review-linux-firewalls.html" target="_blank">talking about it a few posts ago</a>. Using  psad to parse the log files you can be notified of network attacks in  real time, the end of the tiresome log surfing after the attack already  taken place.</span><br /><br /></div><div><span style="font-family: arial,helvetica,sans-serif;">The only  thing we're missing is the notification, well, that was easier than I  thought because psad can execute a script every time an attack is  detected. Keeping this  in mind, and using notify-send capabilities, we can have a visual  notification spawned by psad upon an attack detection.</span></div><div><span style="font-family: arial,helvetica,sans-serif;"><br clear="none" /></span></div><div><span style="font-family: arial,helvetica,sans-serif;">Here follows the configurations I've used to turn the idea into reality.</span></div><div><span style="font-family: arial,helvetica,sans-serif;">(I've tested it on xubuntu, but this would be identical on other distros)</span></div><div><span style="font-family: arial,helvetica,sans-serif;"><br clear="none" /></span></div><div><span style="font-family: arial,helvetica,sans-serif;">First the software requirements:</span></div><blockquote class="tr_bq"><div><span style="font-family: arial,helvetica,sans-serif;">apt-get install iptables-persistent</span></div><div><span style="font-family: arial,helvetica,sans-serif;"><span style="font-family: arial,helvetica,sans-serif;">apt-get install libnotify-bin</span></span></div><div><span style="font-family: arial,helvetica,sans-serif;">apt-get install psad</span></div></blockquote><div><span style="font-family: arial,helvetica,sans-serif;">For the iptables configuration you may use <a href="https://github.com/kintoandar/shell_scripts/blob/master/automation/iptables.sh" target="_blank">my template</a> and tailor it to you likings.</span></div><div><span style="font-family: arial,helvetica,sans-serif;"><br clear="none" /></span></div><div><span style="font-family: arial,helvetica,sans-serif;">Edit the psad configuration file&nbsp;<span style="font-family: arial,helvetica,sans-serif;">/etc/psad/psad.conf</span> and change the following variables accordingly, I'll explain each one of them.</span></div><div><span style="font-family: arial,helvetica,sans-serif;">Change <span style="color: red;">USERNAME</span> with your system username.</span></div><blockquote class="tr_bq"><div><span style="font-family: arial,helvetica,sans-serif;"># This variable is just for future reference, because we want visual notifications, not email</span></div><div><span style="font-family: arial,helvetica,sans-serif;">EMAIL_ADDRESSES&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: red;">USERNAME</span>@machine.lan;</span></div><div><span style="font-family: arial,helvetica,sans-serif;"><br clear="none" /></span></div><div><span style="font-family: arial,helvetica,sans-serif;"># Here we disable the email notifications</span></div><div><span style="font-family: arial,helvetica,sans-serif;">ALERTING_METHODS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; noemail;</span></div><div><span style="font-family: arial,helvetica,sans-serif;"><br clear="none" /></span></div><div><span style="font-family: arial,helvetica,sans-serif;"># Point the following variable to the correct log file (redhat based systems should be /var/log/messages)</span></div><div><span style="font-family: arial,helvetica,sans-serif;">IPT_SYSLOG_FILE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp; /var/log/syslog;</span></div></blockquote><blockquote class="tr_bq"><span style="font-family: Arial,Helvetica,sans-serif;">### Enable psad to run an external script or program (use at your</span><br /><span style="font-family: Arial,Helvetica,sans-serif;">### own risk!)</span><br /><span style="font-family: Arial,Helvetica,sans-serif;">ENABLE_EXT_SCRIPT_EXEC&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Y;</span></blockquote><blockquote class="tr_bq"><div><span style="font-family: arial,helvetica,sans-serif;"></span></div><div><span style="font-family: arial,helvetica,sans-serif;"># DISPLAY and XAUTHORITY are used to define the where and how to connect to the user desktop</span></div><div><span style="font-family: arial,helvetica,sans-serif;"># The nofify-send flags:</span></div><div><span style="font-family: arial,helvetica,sans-serif;"># -t tells to keep the notification visible until closed by the user</span></div><div><span style="font-family: arial,helvetica,sans-serif;"># -i path to an image that will be displayed on the notification</span></div><div><span style="font-family: arial,helvetica,sans-serif;"># -c what is the type of the notification</span></div><div><span style="font-family: arial,helvetica,sans-serif;"># Then follows the title and the body <span style="font-family: arial,helvetica,sans-serif;">of the notification</span>, SRCIP is a psad internal variable that hold the source IP of the attacker</span></div><div><span style="font-family: arial,helvetica,sans-serif;">EXTERNAL_SCRIPT&nbsp;&nbsp;&nbsp;&nbsp;  &nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp; DISPLAY=:0.0 XAUTHORITY=/home/<span style="color: red;">USERNAME</span>/.Xauthority  notify-send -t 0 -i  /usr/share/icons/Tango/scalable/emblems/emblem-important.svg -c network  "Firewall Alert" "Intrusion detected from SRCIP";</span></div><div><span style="font-family: arial,helvetica,sans-serif;"><br clear="none" /></span></div><div><span style="font-family: arial,helvetica,sans-serif;"># You want to always be notified each time an attack is detected, even if it is from the same source</span></div><div><span style="font-family: arial,helvetica,sans-serif;">EXEC_EXT_SCRIPT_PER_ALERT&nbsp;&nbsp; Y;</span></div></blockquote><div><span style="font-family: arial,helvetica,sans-serif;">All done, save the file.</span></div><div><span style="font-family: arial,helvetica,sans-serif;"><br clear="none" /></span></div><div><span style="font-family: arial,helvetica,sans-serif;">Deploy your  iptables rules policy, restart psad daemon, go to another machine on the  network and run nmap against your host, for example a simple syn scan  without pinging:</span><br /><blockquote class="tr_bq"><span style="font-family: arial,helvetica,sans-serif;">nmap -P0 -sS 192.168.1.66</span><br /><span style="font-family: arial,helvetica,sans-serif;"></span></blockquote></div><div><span style="font-family: arial,helvetica,sans-serif;">You should now be presented with something like this on your host:</span><br /><br /></div><div></div><div class="separator" style="clear: both; text-align: center;"><a href="http://kintoandar.blogspot.com/2012/01/attack-detection-and-notification-with.html" imageanchor="1" style="margin-left: 1em; margin-right: 1em;" target="_blank"><img border="0" height="136" src="https://1.bp.blogspot.com/-kXqtZMuKqzI/TybH8ERG3RI/AAAAAAAAAfs/S4bda4BuQaA/s320/notify-send.png" width="320" /></a></div><div></div><div style="font-family: Arial,Helvetica,sans-serif;"><br />Special thanks to <span class="credits"><a href="http://cipherdyne.org/author.html" target="_blank">Michael Rash</a> for psad and the </span>one of my favorite books<a href="http://nostarch.com/firewalls.htm" target="_blank"> Attack Detection and Response with iptables, psad, and fwsnort</a>.</div>
