---
layout: post
title: Nagios NRPE OSSEC check
date: '2011-01-28T12:34:00.004Z'
author: Joel Bastos
tags: 
modified_time: '2011-11-15T11:54:17.166Z'
thumbnail: http://1.bp.blogspot.com/_iWsqNoMkfno/TUK5ozI7AYI/AAAAAAAAAPw/WoF1ZthXc98/s72-c/check_ossec.png
blogger_id: tag:blogger.com,1999:blog-1780138848439428569.post-2923079171145195919
blogger_orig_url: http://blog.kintoandar.com/2011/01/nagios-nrpe-ossec-check.html
comments: true
---

<div style="font-family: Arial,Helvetica,sans-serif;">For some time now I've been testing <a href="http://www.ossec.net/" target="blank">OSSEC</a> on my own infrastucture, so far it's one of the best <a href="http://en.wikipedia.org/wiki/Intrusion_detection_system" target="blank">IDS</a> software I've implemented. Unfortunately the only method of alerting it has is via mail, being an hardcore <a href="http://www.nagios.org/" target="blank">Nagios</a> fanatic I've been searching for a way to integrate OSSEC alerts on it.</div><div style="font-family: Arial,Helvetica,sans-serif;">None of the solutions I've encountered on the web sufficed, so nothing better than creating my own and sharing it with you.</div><div style="font-family: Arial,Helvetica,sans-serif;">Well, with little personal time to spare I decided that It would be something quick and dirty, so nothing like a log parser to get the job done.</div><div style="font-family: Arial,Helvetica,sans-serif;"><br /></div><div style="font-family: Arial,Helvetica,sans-serif;">The idea is pretty simple, ossec-server has an alert.log file that gathers all the events of its agents, each event has an alert level associated with it and the log file is rotated each day.</div><div style="font-family: Arial,Helvetica,sans-serif;">In my case I just needed to search the log for an alert level equal or higher than 7 (ex: ' integrity checksum changed', 'user missed the password more than one time', etc...) and pass the information to nagios-server in a formatted string like "HOST ALERT_LEVEL CAUSE".</div><div style="font-family: Arial,Helvetica,sans-serif;"><br /></div><div style="font-family: Arial,Helvetica,sans-serif;">Using <a href="http://nagios.sourceforge.net/docs/nrpe/NRPE.pdf" target="blank">NRPE</a> daemon to call the script and ensuring that the message reaches nagios-server, all pieces were in place and my problem solved, here's how it looks on Nagios:</div><div style="font-family: Arial,Helvetica,sans-serif;"><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/_iWsqNoMkfno/TUK5ozI7AYI/AAAAAAAAAPw/WoF1ZthXc98/s1600/check_ossec.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;" target="blank"><img border="0" height="77" src="http://1.bp.blogspot.com/_iWsqNoMkfno/TUK5ozI7AYI/AAAAAAAAAPw/WoF1ZthXc98/s320/check_ossec.png" width="320" /></a></div><div class="separator" style="clear: both; text-align: center;"></div></div><div style="font-family: Arial,Helvetica,sans-serif;"><br /><i><span style="color: red;">[root@banshee ~]$</span> cat /etc/scripts/check_ossec.pl </i></div><blockquote style="font-family: Arial,Helvetica,sans-serif;">#!/usr/bin/perl<br /><br />##############<br /># kintoandar <br />##############<br /><br />use strict;<br />use warnings;<br /><br />#--------------------------- Variables ------------------------------<br /># Where is the ossec alert.log?<br /># (nagios must belong to ossec /etc/group so it can open the log)<br />my $alert_log="/opt/ossec/logs/alerts/alerts.log";<br /><br /># What level is critical for you?<br />my $critical="7";<br /><br /># What is the OSSEC-Server name?<br />my $ossec="banshee";<br /><br />#---------------------------- Parser --------------------------------<br />my @text=`grep "(level" -B 1 $alert_log`;<br />my $size=@text;<br />my @level="";<br />my $msg="";<br />my @host="";<br />my $count=0;<br />my $num=0;<br />for ($count=0;$count&lt;$size;$count++){ <br />&nbsp;&nbsp;&nbsp; if ($text[$count] =~ m/level/){<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; @level="";<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; @level=split(/\(level /, $text[$count]);<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; @level=split(/\) -&gt;/, $level[1]);<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; if ($level[0] &gt;= $critical){<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp; chomp ($level[1]);<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp; if ($text[$count-1] !~ m/$ossec/){<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; @host=$text[$count-1];<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; @host=split(/ \(/, $host[0]);<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; @host=split(/\) /, $host[1]);<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; $host[0]=uc ($host[0]);<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }else{<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; $host[0]=uc ($ossec);<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; $num++;<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; $msg=$msg."[$host[0] level=$level[0]$level[1]]";<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp; }<br />}<br /><br />#-------------------------- Send to Nagios ---------------------------<br />if ($msg eq ""){<br />&nbsp;&nbsp;&nbsp; print "No security threats found";<br />&nbsp;&nbsp;&nbsp; exit 0;<br />}else{<br />&nbsp;&nbsp;&nbsp; print "$num alerts found: $msg";<br />&nbsp;&nbsp;&nbsp; exit 2;<br />}<br />print "Something is wrong, script went out of bounds?";<br />exit 1;</blockquote><span class="Apple-style-span" style="font-family: Arial, Helvetica, sans-serif;"><br /></span><br /><span class="Apple-style-span" style="font-family: Arial, Helvetica, sans-serif;"><br /></span><br /><span class="Apple-style-span" style="font-family: Arial, Helvetica, sans-serif;"><span class="Apple-style-span" style="color: red;">Link to github: </span>&nbsp;<a href="http://git.io/Vi5Nrg" target="_blank">http://git.io/Vi5Nrg</a></span>
